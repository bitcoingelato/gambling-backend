<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Gelato</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .game-section, .login-section { margin: 20px 0; }
        .crash-controls button { margin: 5px; }
        #crashMultiplier { font-size: 2em; color: green; }
        .hidden { display: none; }
        .error { color: red; font-size: 0.9em; }
    </style>
    <!-- hCaptcha Script -->
    <script src="https://hcaptcha.com/1/api.js" async defer></script>
</head>
<body>
    <div class="nav">
        <div class="auth">
            <button id="loginBtn">Login</button>
            <button id="signupBtn">Sign Up</button>
        </div>
        <div id="userInfo" class="hidden">
            Welcome, <span id="username"></span> | Balance: <span id="balance">0.0100 BTC (Fun Mode)</span>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="game-menu">
        <button onclick="showGame('crash')">Crash</button>
        <button onclick="showGame('coinflip')">Coinflip</button>
        <button onclick="showGame('roulette')">Roulette</button>
        <button onclick="showGame('threecp')">3CP</button>
        <button onclick="showGame('account')">Account</button>
    </div>

    <div id="gameArea">
        <!-- Login Section -->
        <div id="loginSection" class="login-section hidden">
            <h2>Login</h2>
            <input type="text" id="loginUsername" placeholder="Username">
            <input type="password" id="loginPassword" placeholder="Password">
            <button onclick="login()">Login</button>
            <div id="loginError" class="error"></div>
        </div>

        <!-- Signup Section -->
        <div id="signupSection" class="login-section hidden">
            <h2>Sign Up</h2>
            <input type="text" id="signupUsername" placeholder="Username">
            <div id="usernameError" class="error"></div>
            <input type="email" id="signupEmail" placeholder="Email">
            <div id="emailError" class="error"></div>
            <input type="password" id="signupPassword" placeholder="Password">
            <div id="passwordError" class="error"></div>
            <div class="h-captcha" data-sitekey="b1e64024-155e-43da-a5e6-9b56729c337e"></div> <!-- Replace with your hCaptcha site key -->
            <div id="captchaError" class="error"></div>
            <button onclick="signup()">Sign Up</button>
            <div id="signupResult" class="error"></div>
        </div>

        <!-- Crash Game -->
        <div id="crashSection" class="game-section hidden">
            <h2>Crash</h2>
            <div>Multiplier: <span id="crashMultiplier">1.00x</span></div>
            <input type="number" id="crashBet" placeholder="Bet Amount (BTC)" min="0.001" step="0.001" value="0.001">
            <div class="crash-controls">
                <button onclick="placeBet()">Place Bet</button>
                <button id="cancelBetBtn" onclick="cancelBet()" disabled>Cancel Bet</button>
                <button id="cashoutBtn" onclick="cashOut()" disabled>Cash Out</button>
                <button onclick="verifyFairness()">Verify Fairness</button>
            </div>
            <div>Next round in <span id="crashTimer">9s</span></div>
            <div>Round History
                <table>
                    <tr><th>Crash Point</th><th>Round #</th><th>Bet</th><th>Verify</th><th>Time</th></tr>
                </table>
            </div>
        </div>

        <!-- Other Games (Placeholder) -->
        <div id="coinflipSection" class="game-section hidden">
            <h2>Coinflip</h2>
        </div>
        <div id="rouletteSection" class="game-section hidden">
            <h2>Roulette</h2>
        </div>
        <div id="threecpSection" class="game-section hidden">
            <h2>3 Card Poker (3CP)</h2>
        </div>
        <div id="accountSection" class="game-section hidden">
            <h2>Account</h2>
        </div>
    </div>

    <script>
        let currentUser = null;
        let crashInterval = null;
        let betPlaced = false;
        let currentMultiplier = 1.0;

        function showGame(game) {
            document.querySelectorAll('.game-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`${game}Section`).classList.remove('hidden');
        }

        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            fetch('https://desolate-shore-72677-e0fe07c2f233.herokuapp.com/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                const errorDiv = document.getElementById('loginError');
                if (data.success) {
                    currentUser = username;
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('username').textContent = username;
                    document.getElementById('balance').textContent = `${data.balance || 0} BTC (Fun Mode)`;
                    document.getElementById('loginSection').classList.add('hidden');
                    errorDiv.textContent = '';
                } else {
                    errorDiv.textContent = data.message;
                }
            });
        }

        function signup() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const captchaToken = document.querySelector('.h-captcha').dataset.hcaptchaResponse || '';

            // Clear previous errors
            document.getElementById('usernameError').textContent = '';
            document.getElementById('emailError').textContent = '';
            document.getElementById('passwordError').textContent = '';
            document.getElementById('captchaError').textContent = '';
            document.getElementById('signupResult').textContent = '';

            // Basic client-side validation
            if (!username) document.getElementById('usernameError').textContent = 'Username is required';
            if (!email) document.getElementById('emailError').textContent = 'Email is required';
            if (!password) document.getElementById('passwordError').textContent = 'Password is required';
            else if (password.length < 6) document.getElementById('passwordError').textContent = 'Password must be at least 6 characters';
            if (!captchaToken) document.getElementById('captchaError').textContent = 'Please complete the CAPTCHA';

            if (!username || !email || !password || password.length < 6 || !captchaToken) return;

            fetch('https://desolate-shore-72677-e0fe07c2f233.herokuapp.com/api/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, email, password, captchaToken })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('signupResult');
                if (data.success) {
                    resultDiv.textContent = data.message;
                    resultDiv.style.color = 'green';
                    document.getElementById('signupSection').classList.add('hidden');
                } else {
                    resultDiv.textContent = data.message;
                    resultDiv.style.color = 'red';
                }
            });
        }

        function startCrashGame() {
            if (crashInterval) clearInterval(crashInterval);
            currentMultiplier = 1.0;
            document.getElementById('crashMultiplier').textContent = `${currentMultiplier.toFixed(2)}x`;
            document.getElementById('cashoutBtn').disabled = true;
            document.getElementById('cancelBetBtn').disabled = true;
            let timeLeft = 9;
            document.getElementById('crashTimer').textContent = `${timeLeft}s`;
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('crashTimer').textContent = `${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    simulateCrash();
                }
            }, 1000);
        }

        function simulateCrash() {
            if (betPlaced) {
                currentMultiplier += 0.1;
                document.getElementById('crashMultiplier').textContent = `${currentMultiplier.toFixed(2)}x`;
                document.getElementById('crashMultiplier').style.color = 'red';
                if (Math.random() < 0.1) {
                    endCrash();
                } else {
                    setTimeout(simulateCrash, 100);
                }
            }
        }

        function endCrash() {
            if (betPlaced) {
                alert('Crash! You lost your bet.');
                betPlaced = false;
                document.getElementById('cashoutBtn').disabled = true;
                document.getElementById('cancelBetBtn').disabled = true;
            }
            startCrashGame();
        }

        function placeBet() {
            if (!currentUser) {
                alert('Please log in first!');
                return;
            }
            const betAmount = parseFloat(document.getElementById('crashBet').value);
            fetch('https://desolate-shore-72677-e0fe07c2f233.herokuapp.com/api/crash/bet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser, betAmount })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    betPlaced = true;
                    document.getElementById('cashoutBtn').disabled = false;
                    document.getElementById('cancelBetBtn').disabled = false;
                    document.getElementById('balance').textContent = `${data.remainingBalance} BTC (Fun Mode)`;
                    startCrashGame();
                } else {
                    alert(data.message);
                }
            });
        }

        function cashOut() {
            if (!betPlaced) return;
            const multiplier = currentMultiplier;
            fetch('https://desolate-shore-72677-e0fe07c2f233.herokuapp.com/api/crash/cashout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser, multiplier })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Cashed out at ${multiplier.toFixed(2)}x! Payout: ${data.payout} BTC`);
                    document.getElementById('balance').textContent = `${data.newBalance} BTC (Fun Mode)`;
                    betPlaced = false;
                    document.getElementById('cashoutBtn').disabled = true;
                    document.getElementById('cancelBetBtn').disabled = true;
                } else {
                    alert(data.message);
                }
            });
        }

        function cancelBet() {
            if (betPlaced) {
                fetch('https://desolate-shore-72677-e0fe07c2f233.herokuapp.com/api/deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, amount: parseFloat(document.getElementById('crashBet').value) })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('balance').textContent = `${data.newBalance} BTC (Fun Mode)`;
                        betPlaced = false;
                        document.getElementById('cashoutBtn').disabled = true;
                        document.getElementById('cancelBetBtn').disabled = true;
                        alert('Bet cancelled and refunded.');
                    }
                });
            }
        }

        function verifyFairness() {
            alert('Fairness verification: Simulated for now. Use server/client seeds in production.');
        }

        document.getElementById('loginBtn').addEventListener('click', () => showGame('loginSection'));
        document.getElementById('signupBtn').addEventListener('click', () => showGame('signupSection'));
        showGame('crash');
        startCrashGame();
    </script>
</body>
</html>
