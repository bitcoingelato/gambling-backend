<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bitcoin Gelato Casino</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial; background: #000; color: #fff; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { background: #333; padding: 10px; text-align: center; }
        .tabs { margin: 10px 0; text-align: center; }
        .tab { color: #FFC107; text-decoration: none; margin: 0 10px; cursor: pointer; }
        .tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .section { background: #222; padding: 10px; margin-bottom: 10px; }
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #333; padding: 20px; width: 300px; text-align: center; }
        .modal-tabs { display: flex; margin-bottom: 20px; }
        .modal-tab { flex: 1; padding: 10px; cursor: pointer; color: #FFC107; }
        .modal-tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .modal-content input, .modal-content button { width: 100%; padding: 8px; margin: 10px 0; background: #444; color: #fff; border: 1px solid #FFC107; }
        .modal-content button { background: #FFC107; color: #000; border: none; cursor: pointer; }
        .error { color: #FF0000; font-size: 0.9em; margin-top: 5px; }
        .multiplier { font-size: 1.5em; background: #FFC107; color: #000; padding: 5px; text-align: center; }
        .bet-controls { text-align: center; margin: 10px 0; }
        .bet-controls input, .bet-controls select { padding: 5px; margin: 5px; background: #444; color: #fff; border: 1px solid #FFC107; }
        .bet-controls button { padding: 5px 10px; margin: 5px; background: #FFC107; color: #000; border: none; cursor: pointer; }
        .bet-controls button:disabled { background: #666; }
        .crash-timer { text-align: center; color: #FFC107; }
    </style>
</head>
<body>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-tabs">
                <div id="loginTab" class="modal-tab active">Login</div>
                <div id="signupTab" class="modal-tab">Sign Up</div>
            </div>
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="Username">
                <input type="password" id="loginPassword" placeholder="Password">
                <button id="loginButton">Login</button>
                <p id="loginError" class="error hidden"></p>
            </div>
            <div id="signupForm" class="hidden">
                <input type="text" id="signupUsername" placeholder="Username">
                <input type="email" id="signupEmail" placeholder="Email">
                <input type="password" id="signupPassword" placeholder="Password">
                <button id="signupButton">Sign Up</button>
                <p id="signupError" class="error hidden"></p>
            </div>
        </div>
    </div>
    <div id="gameInterface" class="hidden">
        <div class="header">
            <span>Welcome, <span id="headerUsername">Guest</span> | Balance: <span id="balance">0.0000</span> BTC</span>
            <button id="logoutButton">Logout</button>
        </div>
        <div class="tabs">
            <a id="tabCrash" class="tab active">Crash</a>
            <a id="tabCoinflip" class="tab">Coinflip</a>
            <a id="tabRoulette" class="tab">Roulette</a>
            <a id="tab3CP" class="tab">3CP</a>
        </div>
        <div class="container">
            <div id="crashSection" class="section">
                <h2>Crash</h2>
                <div class="multiplier" id="multiplier">1.00x</div>
                <div class="bet-controls">
                    <input type="number" id="crashBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <button id="placeBetButton">Place Bet</button>
                    <button id="cashoutButton" disabled>Cash Out</button>
                </div>
                <div class="crash-timer" id="crashTimer">Next round in ...</div>
                <div class="error" id="crashError"></div>
            </div>
            <div id="coinflipSection" class="section hidden">
                <h2>Coinflip</h2>
                <div class="bet-controls">
                    <input type="number" id="coinflipBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <select id="coinflipChoice">
                        <option value="heads">Heads</option>
                        <option value="tails">Tails</option>
                    </select>
                    <button id="coinflipButton">Flip Coin</button>
                </div>
                <div class="error" id="coinflipError"></div>
                <p><strong>Result:</strong> <span id="coinflipResult">-</span></p>
            </div>
            <div id="rouletteSection" class="section hidden">
                <h2>Roulette</h2>
                <div class="bet-controls">
                    <input type="number" id="rouletteBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <select id="rouletteColor">
                        <option value="red">Red</option>
                        <option value="black">Black</option>
                        <option value="green">Green</option>
                    </select>
                    <button id="rouletteBetButton">Place Bet</button>
                </div>
                <div class="error" id="rouletteError"></div>
                <p><strong>Result:</strong> <span id="rouletteResult">-</span></p>
            </div>
            <div id="threecpSection" class="section hidden">
                <h2>3 Card Poker</h2>
                <div class="bet-controls">
                    <input type="number" id="threecpBetAmount" placeholder="Ante Bet (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <button id="threecpBetButton">Deal Hand</button>
                </div>
                <div class="error" id="threecpError"></div>
                <p><strong>Your Hand:</strong> <span id="threecpPlayerHand">-</span></p>
                <p><strong>Dealer's Hand:</strong> <span id="threecpDealerHand">-</span></p>
                <p><strong>Result:</strong> <span id="threecpResult">-</span></p>
            </div>
        </div>
    </div>
<script>
const API = 'https://desolate-shore-72677-e0fe07c2f233.herokuapp.com';
let authToken = localStorage.getItem('token') || null;
let crashStatePoller = null;
let userBetThisRound = false;

// UI helpers
function showModal(tab) {
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('gameInterface').classList.add('hidden');
    for (const form of ["loginForm","signupForm"]) document.getElementById(form).classList.add('hidden');
    for (const tabid of ["loginTab","signupTab"]) document.getElementById(tabid).classList.remove('active');
    if(tab==="login"){document.getElementById('loginForm').classList.remove('hidden');document.getElementById('loginTab').classList.add('active');}
    else{document.getElementById('signupForm').classList.remove('hidden');document.getElementById('signupTab').classList.add('active');}
}
function showGame() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('gameInterface').classList.remove('hidden');
    document.getElementById('headerUsername').textContent = localStorage.getItem('username') || 'Guest';
    pollCrashState();
    if (crashStatePoller) clearInterval(crashStatePoller);
    crashStatePoller = setInterval(pollCrashState, 1000);
}
// Tab switching
for (const tab of ["Crash","Coinflip","Roulette","3CP"]) {
    document.getElementById("tab"+tab).onclick = () => {
        for(const s of ["crashSection","coinflipSection","rouletteSection","threecpSection"]) document.getElementById(s).classList.add('hidden');
        for(const t of ["tabCrash","tabCoinflip","tabRoulette","tab3CP"]) document.getElementById(t).classList.remove('active');
        document.getElementById("tab"+tab).classList.add('active');
        document.getElementById((tab==="3CP"?"threecp":tab.toLowerCase())+"Section").classList.remove('hidden');
    };
}
document.getElementById('loginTab').onclick = () => showModal('login');
document.getElementById('signupTab').onclick = () => showModal('signup');

// Auth/Login/Signup
document.getElementById('loginButton').onclick = async function() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    errorEl.classList.add('hidden'); errorEl.textContent = '';
    try {
        const res = await fetch(`${API}/api/login`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username, password})
        });
        const data = await res.json();
        if (data.success && data.token) {
            authToken = data.token;
            localStorage.setItem('token', authToken);
            localStorage.setItem('username', data.username);
            showGame();
            fetchBalance();
        } else {
            errorEl.textContent = data.message || 'Login failed.'; errorEl.classList.remove('hidden');
        }
    } catch (e) { errorEl.textContent = 'Network error.'; errorEl.classList.remove('hidden'); }
};

document.getElementById('signupButton').onclick = async function() {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const errorEl = document.getElementById('signupError');
    errorEl.classList.add('hidden'); errorEl.textContent = ''; errorEl.style.color = "#FF0000";
    if (!username || !email || !password) { errorEl.textContent = 'All fields required.'; errorEl.classList.remove('hidden'); return; }
    if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters.'; errorEl.classList.remove('hidden'); return; }
    try {
        const res = await fetch(`${API}/api/signup`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username, email, password})
        });
        const data = await res.json();
        if (data.success) {
            errorEl.style.color = "#00FF00";
            errorEl.textContent = 'Signup successful! Logging you in...';
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = password;
            setTimeout(() => { document.getElementById('loginTab').click(); document.getElementById('loginButton').click(); }, 600);
        } else {
            errorEl.textContent = data.message || 'Signup failed.'; errorEl.classList.remove('hidden');
        }
    } catch (e) { errorEl.textContent = 'Network error.'; errorEl.classList.remove('hidden'); }
};

document.getElementById('logoutButton').onclick = function() {
    localStorage.removeItem('token'); localStorage.removeItem('username');
    authToken = null;
    showModal('login');
    if (crashStatePoller) clearInterval(crashStatePoller);
};
async function fetchBalance() {
    if (!authToken) return;
    try {
        const res = await fetch(`${API}/api/balance`, { method: 'GET', headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        if (data.success) document.getElementById('balance').textContent = (data.balance || 0).toFixed(4);
    } catch (e) {}
}

// Crash game
function setCrashUI(state) {
    document.getElementById('crashError').textContent = '';
    if (!state) {
        document.getElementById('multiplier').textContent = 'Waiting...';
        document.getElementById('crashTimer').textContent = 'Waiting for next round...';
        document.getElementById('placeBetButton').disabled = true;
        document.getElementById('cashoutButton').disabled = true;
        userBetThisRound = false;
        return;
    }
    document.getElementById('multiplier').textContent = (state.multiplier || 1).toFixed(2) + 'x';
    if (state.status === 'running') {
        document.getElementById('crashTimer').textContent = 'Round in progress';
        document.getElementById('placeBetButton').disabled = userBetThisRound;
        document.getElementById('cashoutButton').disabled = !userBetThisRound;
    } else {
        document.getElementById('crashTimer').textContent = 'Next round in a few seconds...';
        document.getElementById('placeBetButton').disabled = true;
        document.getElementById('cashoutButton').disabled = true;
        userBetThisRound = false;
    }
}
async function pollCrashState() {
    try {
        const res = await fetch(`${API}/api/crash/state`);
        const data = await res.json();
        if (data.success) setCrashUI(data.round);
    } catch (e) {
        document.getElementById('crashError').textContent = 'Cannot connect to server.';
    }
}
document.getElementById('placeBetButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('crashBetAmount').value);
    if (!amt || amt <= 0) return alert('Enter a valid bet.');
    try {
        const res = await fetch(`${API}/api/crash/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt })
        });
        const data = await res.json();
        if (data.success) { userBetThisRound = true; fetchBalance(); }
        else alert(data.message || 'Bet failed.');
    } catch (e) { alert('Network error.'); }
};
document.getElementById('cashoutButton').onclick = async function() {
    try {
        const res = await fetch(`${API}/api/crash/cashout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        if (data.success) { alert(`Cashed out for ${data.payout} BTC at ${data.multiplier.toFixed(2)}x!`); userBetThisRound = false; fetchBalance(); }
        else alert(data.message || 'Cashout failed.');
    } catch (e) { alert('Network error.'); }
};

// Coinflip
document.getElementById('coinflipButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('coinflipBetAmount').value);
    const choice = document.getElementById('coinflipChoice').value;
    const err = document.getElementById('coinflipError');
    err.textContent = '';
    if (!amt || amt <= 0) return err.textContent = 'Enter a valid bet.';
    try {
        const res = await fetch(`${API}/api/coinflip/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt, choice })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('coinflipResult').textContent = `Result: ${data.result} — ${data.win ? "WIN" : "LOSE"}`;
            fetchBalance();
        } else err.textContent = data.message || 'Bet failed.';
    } catch (e) { err.textContent = 'Network error.'; }
};

// Roulette
document.getElementById('rouletteBetButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('rouletteBetAmount').value);
    const color = document.getElementById('rouletteColor').value;
    const err = document.getElementById('rouletteError');
    err.textContent = '';
    if (!amt || amt <= 0) return err.textContent = 'Enter a valid bet.';
    try {
        const res = await fetch(`${API}/api/roulette/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt, color })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('rouletteResult').textContent = `Result: ${data.result} — ${data.payout > 0 ? "WIN" : "LOSE"}`;
            fetchBalance();
        } else err.textContent = data.message || 'Bet failed.';
    } catch (e) { err.textContent = 'Network error.'; }
};

// 3 Card Poker
document.getElementById('threecpBetButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('threecpBetAmount').value);
    const err = document.getElementById('threecpError');
    err.textContent = '';
    if (!amt || amt <= 0) return err.textContent = 'Enter a valid bet.';
    try {
        const res = await fetch(`${API}/api/3cp/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('threecpPlayerHand').textContent = data.player.join(' ');
            document.getElementById('threecpDealerHand').textContent = data.dealer.join(' ');
            document.getElementById('threecpResult').textContent = data.win ? `WIN (+${data.payout})` : "LOSE";
            fetchBalance();
        } else err.textContent = data.message || 'Bet failed.';
    } catch (e) { err.textContent = 'Network error.'; }
};

// Startup
(function() {
    if (authToken && localStorage.getItem('username')) { showGame(); fetchBalance(); }
    else { showModal('login'); }
})();
</script>
</body>
</html>
