<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bitcoin Gelato Casino</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; margin: 0; padding: 10px; }
        .container { max-width: 700px; margin: 0 auto; }
        .header { background: #212121; padding: 16px; text-align: center; border-radius: 10px; margin-bottom: 20px; }
        .tabs { margin: 10px 0 20px 0; text-align: center; }
        .tab { color: #FFC107; text-decoration: none; margin: 0 16px; cursor: pointer; font-size: 1.1em; }
        .tab.active { color: #fff; border-bottom: 2px solid #FFC107; }
        .section { background: #222; padding: 16px; margin-bottom: 16px; border-radius: 10px; box-shadow: 0 2px 8px #1116; }
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #333; padding: 28px 24px; width: 320px; text-align: center; border-radius: 12px; }
        .modal-tabs { display: flex; margin-bottom: 20px; }
        .modal-tab { flex: 1; padding: 10px; cursor: pointer; color: #FFC107; font-weight: bold; }
        .modal-tab.active { color: #fff; border-bottom: 2px solid #FFC107; }
        .modal-content input, .modal-content button { width: 100%; padding: 10px; margin: 12px 0; background: #444; color: #fff; border: 1px solid #FFC107; border-radius: 6px; }
        .modal-content button { background: #FFC107; color: #000; border: none; font-weight: bold; cursor: pointer; }
        .error { color: #FF5252; font-size: 0.98em; margin-top: 5px; }
        .success { color: #00e676; font-size: 0.98em; margin-top: 5px; }
        .multiplier { font-size: 2em; background: #FFC107; color: #232323; padding: 8px 0; border-radius: 6px; margin-bottom: 12px; }
        .bet-controls { text-align: center; margin: 10px 0; }
        .bet-controls input, .bet-controls select { padding: 8px; margin: 6px; background: #444; color: #fff; border: 1px solid #FFC107; border-radius: 4px; }
        .bet-controls button { padding: 8px 14px; margin: 6px; background: #FFC107; color: #000; border: none; border-radius: 4px; font-weight: bold; }
        .bet-controls button:disabled { background: #666; color: #bbb; }
        .crash-timer { text-align: center; color: #FFC107; margin: 10px 0 0 0; font-weight: bold; }
        .history-table, .history-table th, .history-table td { border-collapse: collapse; }
        .history-table { width: 100%; margin: 10px 0 0 0; background: #292929; border-radius: 6px; overflow: hidden; }
        .history-table th, .history-table td { border: 1px solid #393939; padding: 8px 4px; text-align: center; }
        .history-table th { background: #333; color: #FFC107; }
        .bet-win { color: #00e676; font-weight: bold; }
        .bet-lose { color: #FF5252; font-weight: bold; }
        .bet-neutral { color: #FFC107; }
        .username { font-weight: bold; color: #FFC107; }
        .footer {text-align:center;font-size:0.9em; color:#888; margin-top: 20px;}
        /* Responsive */
        @media (max-width: 800px) { .container {max-width:97vw;padding:2vw;} }
        @media (max-width: 650px) { .modal-content {width:96vw;} }
    </style>
</head>
<body>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-tabs">
                <div id="loginTab" class="modal-tab active">Login</div>
                <div id="signupTab" class="modal-tab">Sign Up</div>
            </div>
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="Username">
                <input type="password" id="loginPassword" placeholder="Password">
                <button id="loginButton">Login</button>
                <p id="loginError" class="error hidden"></p>
            </div>
            <div id="signupForm" class="hidden">
                <input type="text" id="signupUsername" placeholder="Username">
                <input type="email" id="signupEmail" placeholder="Email">
                <input type="password" id="signupPassword" placeholder="Password">
                <button id="signupButton">Sign Up</button>
                <p id="signupError" class="error hidden"></p>
            </div>
        </div>
    </div>
    <div id="gameInterface" class="hidden">
        <div class="header">
            <span>Welcome, <span id="headerUsername" class="username">Guest</span> | Balance: <span id="balance">0.0000</span> BTC</span>
            <button id="logoutButton" style="float:right;background:#FFC107;color:#222;border-radius:5px;font-weight:bold;">Logout</button>
        </div>
        <div class="tabs">
            <a id="tabCrash" class="tab active">Crash</a>
            <a id="tabCoinflip" class="tab">Coinflip</a>
            <a id="tabRoulette" class="tab">Roulette</a>
            <a id="tab3CP" class="tab">3CP</a>
        </div>
        <div class="container">
            <!-- Crash -->
            <div id="crashSection" class="section">
                <h2>Crash</h2>
                <div class="multiplier" id="multiplier">1.00x</div>
                <div class="bet-controls">
                    <input type="number" id="crashBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <button id="placeBetButton">Place Bet</button>
                    <button id="cashoutButton" disabled>Cash Out</button>
                </div>
                <div id="crashError" class="error"></div>
                <div class="crash-timer" id="crashTimer">Next round in ...</div>
                <h3 style="margin-top:24px;">Crash Bet History</h3>
                <table class="history-table" id="crashHistoryTable">
                    <thead>
                        <tr>
                            <th>Round</th>
                            <th>Bet</th>
                            <th>Cashed Out</th>
                            <th>Payout</th>
                            <th>Crash At</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- Coinflip -->
            <div id="coinflipSection" class="section hidden">
                <h2>Coinflip</h2>
                <div class="bet-controls">
                    <input type="number" id="coinflipBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <select id="coinflipChoice">
                        <option value="heads">Heads</option>
                        <option value="tails">Tails</option>
                    </select>
                    <button id="coinflipButton">Flip Coin</button>
                </div>
                <div id="coinflipError" class="error"></div>
                <p><strong>Result:</strong> <span id="coinflipResult">-</span></p>
                <h3 style="margin-top:24px;">Coinflip Bet History</h3>
                <table class="history-table" id="coinflipHistoryTable">
                    <thead>
                        <tr>
                            <th>Bet</th>
                            <th>Choice</th>
                            <th>Result</th>
                            <th>Outcome</th>
                            <th>Payout</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- Roulette -->
            <div id="rouletteSection" class="section hidden">
                <h2>Roulette</h2>
                <div class="bet-controls">
                    <input type="number" id="rouletteBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <select id="rouletteColor">
                        <option value="red">Red</option>
                        <option value="black">Black</option>
                        <option value="green">Green</option>
                    </select>
                    <button id="rouletteBetButton">Place Bet</button>
                </div>
                <div id="rouletteError" class="error"></div>
                <p><strong>Result:</strong> <span id="rouletteResult">-</span></p>
                <h3 style="margin-top:24px;">Roulette Bet History</h3>
                <table class="history-table" id="rouletteHistoryTable">
                    <thead>
                        <tr>
                            <th>Bet</th>
                            <th>Color</th>
                            <th>Result</th>
                            <th>Payout</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- 3CP -->
            <div id="threecpSection" class="section hidden">
                <h2>3 Card Poker</h2>
                <div class="bet-controls">
                    <input type="number" id="threecpBetAmount" placeholder="Ante Bet (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <button id="threecpBetButton">Deal Hand</button>
                </div>
                <div id="threecpError" class="error"></div>
                <p><strong>Your Hand:</strong> <span id="threecpPlayerHand">-</span></p>
                <p><strong>Dealer's Hand:</strong> <span id="threecpDealerHand">-</span></p>
                <p><strong>Result:</strong> <span id="threecpResult">-</span></p>
                <h3 style="margin-top:24px;">3CP Bet History</h3>
                <table class="history-table" id="threecpHistoryTable">
                    <thead>
                        <tr>
                            <th>Bet</th>
                            <th>Your Hand</th>
                            <th>Dealer</th>
                            <th>Outcome</th>
                            <th>Payout</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="footer">
            &copy; 2025 Bitcoin Gelato Casino | Play responsibly.
        </div>
    </div>
<script>
const API = 'https://desolate-shore-72677-e0fe07c2f233.herokuapp.com';
let authToken = localStorage.getItem('token') || null;
let crashStatePoller = null;
let userBetThisRound = false;

// UI helpers
function showModal(tab) {
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('gameInterface').classList.add('hidden');
    for (const form of ["loginForm","signupForm"]) document.getElementById(form).classList.add('hidden');
    for (const tabid of ["loginTab","signupTab"]) document.getElementById(tabid).classList.remove('active');
    if(tab==="login"){document.getElementById('loginForm').classList.remove('hidden');document.getElementById('loginTab').classList.add('active');}
    else{document.getElementById('signupForm').classList.remove('hidden');document.getElementById('signupTab').classList.add('active');}
}
function showGame() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('gameInterface').classList.remove('hidden');
    document.getElementById('headerUsername').textContent = localStorage.getItem('username') || 'Guest';
    pollCrashState();
    fetchBalance();
    fetchAllHistory();
    if (crashStatePoller) clearInterval(crashStatePoller);
    crashStatePoller = setInterval(pollCrashState, 1000);
}
// Tab switching
for (const tab of ["Crash","Coinflip","Roulette","3CP"]) {
    document.getElementById("tab"+tab).onclick = () => {
        for(const s of ["crashSection","coinflipSection","rouletteSection","threecpSection"]) document.getElementById(s).classList.add('hidden');
        for(const t of ["tabCrash","tabCoinflip","tabRoulette","tab3CP"]) document.getElementById(t).classList.remove('active');
        document.getElementById("tab"+tab).classList.add('active');
        document.getElementById((tab==="3CP"?"threecp":tab.toLowerCase())+"Section").classList.remove('hidden');
        fetchAllHistory();
    };
}
document.getElementById('loginTab').onclick = () => showModal('login');
document.getElementById('signupTab').onclick = () => showModal('signup');

// Auth/Login/Signup
document.getElementById('loginButton').onclick = async function() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    errorEl.classList.add('hidden'); errorEl.textContent = '';
    try {
        const res = await fetch(`${API}/api/login`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username, password})
        });
        const data = await res.json();
        if (data.success && data.token) {
            authToken = data.token;
            localStorage.setItem('token', authToken);
            localStorage.setItem('username', data.username);
            showGame();
        } else {
            errorEl.textContent = data.message || 'Login failed.'; errorEl.classList.remove('hidden');
        }
    } catch (e) { errorEl.textContent = 'Network error.'; errorEl.classList.remove('hidden'); }
};

document.getElementById('signupButton').onclick = async function() {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const errorEl = document.getElementById('signupError');
    errorEl.classList.add('hidden'); errorEl.textContent = ''; errorEl.style.color = "#FF0000";
    if (!username || !email || !password) { errorEl.textContent = 'All fields required.'; errorEl.classList.remove('hidden'); return; }
    if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters.'; errorEl.classList.remove('hidden'); return; }
    try {
        const res = await fetch(`${API}/api/signup`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username, email, password})
        });
        const data = await res.json();
        if (data.success) {
            errorEl.style.color = "#00FF00";
            errorEl.textContent = 'Signup successful! Logging you in...';
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginPassword').value = password;
            setTimeout(() => { document.getElementById('loginTab').click(); document.getElementById('loginButton').click(); }, 600);
        } else {
            errorEl.textContent = data.message || 'Signup failed.'; errorEl.classList.remove('hidden');
        }
    } catch (e) { errorEl.textContent = 'Network error.'; errorEl.classList.remove('hidden'); }
};

document.getElementById('logoutButton').onclick = function() {
    localStorage.removeItem('token'); localStorage.removeItem('username');
    authToken = null;
    showModal('login');
    if (crashStatePoller) clearInterval(crashStatePoller);
};
async function fetchBalance() {
    if (!authToken) return;
    try {
        const res = await fetch(`${API}/api/balance`, { method: 'GET', headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        if (data.success) document.getElementById('balance').textContent = (data.balance || 0).toFixed(4);
    } catch (e) {}
}

// Crash game
function setCrashUI(state) {
    document.getElementById('crashError').textContent = '';
    if (!state) {
        document.getElementById('multiplier').textContent = 'Waiting...';
        document.getElementById('crashTimer').textContent = 'Waiting for next round...';
        document.getElementById('placeBetButton').disabled = true;
        document.getElementById('cashoutButton').disabled = true;
        userBetThisRound = false;
        return;
    }
    document.getElementById('multiplier').textContent = (state.multiplier || 1).toFixed(2) + 'x';
    if (state.status === 'running') {
        document.getElementById('crashTimer').textContent = 'Round in progress';
        document.getElementById('placeBetButton').disabled = userBetThisRound;
        document.getElementById('cashoutButton').disabled = !userBetThisRound;
    } else {
        document.getElementById('crashTimer').textContent = 'Next round in a few seconds...';
        document.getElementById('placeBetButton').disabled = true;
        document.getElementById('cashoutButton').disabled = true;
        userBetThisRound = false;
    }
}
async function pollCrashState() {
    try {
        const res = await fetch(`${API}/api/crash/state`);
        const data = await res.json();
        if (data.success) setCrashUI(data.round);
    } catch (e) {
        document.getElementById('crashError').textContent = 'Cannot connect to server.';
    }
}
document.getElementById('placeBetButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('crashBetAmount').value);
    if (!amt || amt <= 0) return alert('Enter a valid bet.');
    try {
        const res = await fetch(`${API}/api/crash/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt })
        });
        const data = await res.json();
        if (data.success) { userBetThisRound = true; fetchBalance(); fetchCrashHistory(); }
        else alert(data.message || 'Bet failed.');
    } catch (e) { alert('Network error.'); }
};
document.getElementById('cashoutButton').onclick = async function() {
    try {
        const res = await fetch(`${API}/api/crash/cashout`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();
        if (data.success) { alert(`Cashed out for ${data.payout} BTC at ${data.multiplier.toFixed(2)}x!`); userBetThisRound = false; fetchBalance(); fetchCrashHistory(); }
        else alert(data.message || 'Cashout failed.');
    } catch (e) { alert('Network error.'); }
};

// Coinflip
document.getElementById('coinflipButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('coinflipBetAmount').value);
    const choice = document.getElementById('coinflipChoice').value;
    const err = document.getElementById('coinflipError');
    err.textContent = '';
    if (!amt || amt <= 0) return err.textContent = 'Enter a valid bet.';
    try {
        const res = await fetch(`${API}/api/coinflip/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt, choice })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('coinflipResult').textContent = `Result: ${data.result} — ${data.win ? "WIN" : "LOSE"}`;
            fetchBalance(); fetchCoinflipHistory();
        } else err.textContent = data.message || 'Bet failed.';
    } catch (e) { err.textContent = 'Network error.'; }
};

// Roulette
document.getElementById('rouletteBetButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('rouletteBetAmount').value);
    const color = document.getElementById('rouletteColor').value;
    const err = document.getElementById('rouletteError');
    err.textContent = '';
    if (!amt || amt <= 0) return err.textContent = 'Enter a valid bet.';
    try {
        const res = await fetch(`${API}/api/roulette/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt, color })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('rouletteResult').textContent = `Result: ${data.result} — ${data.payout > 0 ? "WIN" : "LOSE"}`;
            fetchBalance(); fetchRouletteHistory();
        } else err.textContent = data.message || 'Bet failed.';
    } catch (e) { err.textContent = 'Network error.'; }
};

// 3 Card Poker
document.getElementById('threecpBetButton').onclick = async function() {
    const amt = parseFloat(document.getElementById('threecpBetAmount').value);
    const err = document.getElementById('threecpError');
    err.textContent = '';
    if (!amt || amt <= 0) return err.textContent = 'Enter a valid bet.';
    try {
        const res = await fetch(`${API}/api/3cp/bet`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
            body: JSON.stringify({ amount: amt })
        });
        const data = await res.json();
        if (data.success) {
            document.getElementById('threecpPlayerHand').textContent = data.player.join(' ');
            document.getElementById('threecpDealerHand').textContent = data.dealer.join(' ');
            document.getElementById('threecpResult').textContent = data.win ? `WIN (+${data.payout})` : "LOSE";
            fetchBalance(); fetchThreecpHistory();
        } else err.textContent = data.message || 'Bet failed.';
    } catch (e) { err.textContent = 'Network error.'; }
};

// --- History fetchers ---
function fetchAllHistory() {
    fetchCrashHistory(); fetchCoinflipHistory(); fetchRouletteHistory(); fetchThreecpHistory();
}
async function fetchCrashHistory() {
    if (!authToken) return;
    try {
        const res = await fetch(`${API}/api/history/crash`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        const tbody = document.querySelector('#crashHistoryTable tbody');
        tbody.innerHTML = '';
        if (data.success && Array.isArray(data.history)) {
            data.history.forEach(round => {
                if (!Array.isArray(round.bets)) return;
                round.bets.filter(b=>b.username===localStorage.getItem('username')).forEach(bet=>{
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${round.roundId}</td>
                        <td>${bet.amount}</td>
                        <td>${bet.cashedOut ? bet.cashedAt?.toFixed(2)+'x' : '-'}</td>
                        <td class="${bet.payout>0?'bet-win':'bet-lose'}">${bet.payout?bet.payout:'-'}</td>
                        <td>${round.crashAt?.toFixed(2)}x</td>
                        <td>${(bet.time?new Date(bet.time):round.created?new Date(round.created):'').toLocaleString()}</td>`;
                    tbody.appendChild(tr);
                });
            });
        }
    } catch (e) {}
}
async function fetchCoinflipHistory() {
    if (!authToken) return;
    try {
        const res = await fetch(`${API}/api/history/coinflip`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        const tbody = document.querySelector('#coinflipHistoryTable tbody');
        tbody.innerHTML = '';
        if (data.success && Array.isArray(data.history)) {
            data.history.forEach(bet => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${bet.amount}</td>
                    <td>${bet.choice}</td>
                    <td>${bet.result}</td>
                    <td class="${bet.win?'bet-win':'bet-lose'}">${bet.win?"WIN":"LOSE"}</td>
                    <td>${bet.payout}</td>
                    <td>${new Date(bet.created).toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        }
    } catch (e) {}
}
async function fetchRouletteHistory() {
    if (!authToken) return;
    try {
        const res = await fetch(`${API}/api/history/roulette`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        const tbody = document.querySelector('#rouletteHistoryTable tbody');
        tbody.innerHTML = '';
        if (data.success && Array.isArray(data.history)) {
            data.history.forEach(bet => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${bet.amount}</td>
                    <td>${bet.color}</td>
                    <td>${bet.result}</td>
                    <td class="${bet.payout>0?'bet-win':'bet-lose'}">${bet.payout}</td>
                    <td>${new Date(bet.created).toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        }
    } catch (e) {}
}
async function fetchThreecpHistory() {
    if (!authToken) return;
    try {
        const res = await fetch(`${API}/api/history/3cp`, { headers: { 'Authorization': `Bearer ${authToken}` } });
        const data = await res.json();
        const tbody = document.querySelector('#threecpHistoryTable tbody');
        tbody.innerHTML = '';
        if (data.success && Array.isArray(data.history)) {
            data.history.forEach(bet => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${bet.amount}</td>
                    <td>${bet.player ? bet.player.join(' ') : '-'}</td>
                    <td>${bet.dealer ? bet.dealer.join(' ') : '-'}</td>
                    <td class="${bet.win?'bet-win':'bet-lose'}">${bet.win?"WIN":"LOSE"}</td>
                    <td>${bet.payout}</td>
                    <td>${new Date(bet.created).toLocaleString()}</td>`;
                tbody.appendChild(tr);
            });
        }
    } catch (e) {}
}

// Startup
(function() {
    if (authToken && localStorage.getItem('username')) { showGame(); }
    else { showModal('login'); }
})();
</script>
</body>
</html>
