<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Gelato Casino</title>
    <style>
        body { font-family: Arial; background: #000; color: #fff; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { background: #333; padding: 10px; text-align: center; }
        .tabs { margin: 10px 0; text-align: center; }
        .tab { color: #FFC107; text-decoration: none; margin: 0 10px; cursor: pointer; }
        .tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .section { background: #222; padding: 10px; margin-bottom: 10px; }
        .hidden { display: none !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #333; padding: 20px; width: 300px; text-align: center; }
        .modal-tabs { display: flex; margin-bottom: 20px; }
        .modal-tab { flex: 1; padding: 10px; cursor: pointer; color: #FFC107; }
        .modal-tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .modal-content input, .modal-content button { width: 100%; padding: 8px; margin: 10px 0; background: #444; color: #fff; border: 1px solid #FFC107; }
        .modal-content button { background: #FFC107; color: #000; border: none; cursor: pointer; }
        .error { color: #FF0000; font-size: 0.9em; margin-top: 5px; }
        .multiplier { font-size: 1.5em; background: #FFC107; color: #000; padding: 5px; text-align: center; }
        .graph { width: 100%; height: 100px; background: #333; border: 1px solid #FFC107; position: relative; }
        .graph-line { position: absolute; bottom: 0; left: 0; height: 2px; background: #00FF00; transition: width 0.1s linear; }
        .graph-crash { position: absolute; bottom: 0; left: 0; height: 100%; background: rgba(255, 0, 0, 0.5); transition: width 0.1s linear; }
        .bet-controls { text-align: center; margin: 10px 0; }
        .bet-controls input, .bet-controls select { padding: 5px; margin: 5px; background: #444; color: #fff; border: 1px solid #FFC107; }
        .bet-controls button { padding: 5px 10px; margin: 5px; background: #FFC107; color: #000; border: none; cursor: pointer; }
        .bet-controls button:disabled { background: #666; }
        .crash-timer { text-align: center; color: #FFC107; }
    </style>
</head>
<body>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-tabs">
                <div id="loginTab" class="modal-tab active">Login</div>
                <div id="signupTab" class="modal-tab">Sign Up</div>
            </div>
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="Username">
                <input type="password" id="loginPassword" placeholder="Password">
                <button id="loginButton">Login</button>
                <p id="loginError" class="error hidden"></p>
            </div>
            <div id="signupForm" class="hidden">
                <input type="text" id="signupUsername" placeholder="Username">
                <input type="email" id="signupEmail" placeholder="Email">
                <input type="password" id="signupPassword" placeholder="Password">
                <button id="signupButton">Sign Up</button>
                <p id="signupError" class="error hidden"></p>
            </div>
        </div>
    </div>
    <div id="gameInterface" class="hidden">
        <div class="header">
            <span>Welcome, <span id="headerUsername">Guest</span> | Balance: <span id="balance">0.0000</span> BTC</span>
            <button id="logoutButton">Logout</button>
        </div>
        <div class="tabs">
            <a id="tabCrash" class="tab active">Crash</a>
            <!-- You can add other tabs for Coinflip, Roulette, etc. -->
        </div>
        <div class="container">
            <div id="crashSection" class="section">
                <h2>Crash</h2>
                <div class="multiplier" id="multiplier">1.00x</div>
                <div class="graph">
                    <div class="graph-line" id="graphLine"></div>
                    <div class="graph-crash" id="graphCrash"></div>
                </div>
                <div class="bet-controls">
                    <input type="number" id="crashBetAmount" placeholder="Bet Amount (BTC)" step="0.00000001" min="0.00000001" value="0.0001">
                    <button id="placeBetButton">Place Bet</button>
                    <button id="cashoutButton" disabled>Cash Out</button>
                </div>
                <div class="crash-timer" id="crashTimer">Next round in ...</div>
                <div class="error" id="crashError"></div>
            </div>
        </div>
    </div>
    <script>
        // ==== CONFIG ====
        const API = 'https://desolate-shore-72677-e0fe07c2f233.herokuapp.com';
        let authToken = localStorage.getItem('token') || null;
        let crashStatePoller = null;
        let currentCrashRoundId = null;
        let userBetThisRound = false;
        let betAmount = 0;

        // ==== MODAL/Login/Signup UI ====
        function showModal(tab) {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('gameInterface').classList.add('hidden');
            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('signupTab').classList.remove('active');
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('signupTab').classList.add('active');
            }
        }
        document.getElementById('loginTab').onclick = () => showModal('login');
        document.getElementById('signupTab').onclick = () => showModal('signup');

        // ==== LOGIN ====
        document.getElementById('loginButton').onclick = async function() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            errorEl.classList.add('hidden');
            errorEl.textContent = '';
            try {
                const res = await fetch(`${API}/api/login`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await res.json();
                if (data.success && data.token) {
                    authToken = data.token;
                    localStorage.setItem('token', authToken);
                    localStorage.setItem('username', data.username);
                    showGame();
                    fetchBalance();
                } else {
                    errorEl.textContent = data.message || 'Login failed.';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'Network error.';
                errorEl.classList.remove('hidden');
            }
        };

        // ==== SIGNUP ====
        document.getElementById('signupButton').onclick = async function() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const errorEl = document.getElementById('signupError');
            errorEl.classList.add('hidden');
            errorEl.textContent = '';
            if (!username || !email || !password) {
                errorEl.textContent = 'All fields required.';
                errorEl.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters.';
                errorEl.classList.remove('hidden');
                return;
            }
            try {
                const res = await fetch(`${API}/api/signup`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({username, email, password})
                });
                const data = await res.json();
                if (data.success) {
                    errorEl.textContent = 'Signup successful! Please login.';
                    errorEl.style.color = '#00FF00';
                } else {
                    errorEl.textContent = data.message || 'Signup failed.';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'Network error.';
                errorEl.classList.remove('hidden');
            }
        };

        // ==== LOGOUT ====
        document.getElementById('logoutButton').onclick = function() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            authToken = null;
            showModal('login');
            if (crashStatePoller) clearInterval(crashStatePoller);
        };

        // ==== SHOW GAME ====
        function showGame() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('gameInterface').classList.remove('hidden');
            document.getElementById('headerUsername').textContent = localStorage.getItem('username') || 'Guest';
            // Start polling crash state
            pollCrashState();
            if (crashStatePoller) clearInterval(crashStatePoller);
            crashStatePoller = setInterval(pollCrashState, 1000);
        }

        // ==== FETCH BALANCE ====
        async function fetchBalance() {
            if (!authToken) return;
            try {
                const res = await fetch(`${API}/api/balance`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('balance').textContent = (data.balance || 0).toFixed(4);
                }
            } catch (e) { }
        }

        // ==== CRASH GAME LOGIC ====
        function setCrashUI(state) {
            document.getElementById('crashError').textContent = '';
            if (!state) {
                document.getElementById('multiplier').textContent = 'Waiting...';
                document.getElementById('crashTimer').textContent = 'Waiting for next round...';
                document.getElementById('placeBetButton').disabled = true;
                document.getElementById('cashoutButton').disabled = true;
                currentCrashRoundId = null;
                userBetThisRound = false;
                return;
            }
            document.getElementById('multiplier').textContent = (state.multiplier || 1).toFixed(2) + 'x';
            if (state.status === 'running') {
                document.getElementById('crashTimer').textContent = 'Round in progress';
                document.getElementById('placeBetButton').disabled = userBetThisRound;
                document.getElementById('cashoutButton').disabled = !userBetThisRound;
            } else {
                document.getElementById('crashTimer').textContent = 'Next round in a few seconds...';
                document.getElementById('placeBetButton').disabled = true;
                document.getElementById('cashoutButton').disabled = true;
                userBetThisRound = false;
            }
            if (currentCrashRoundId !== state.roundId) {
                // New round started
                currentCrashRoundId = state.roundId;
                userBetThisRound = false;
            }
        }

        async function pollCrashState() {
            try {
                const res = await fetch(`${API}/api/crash/state`);
                const data = await res.json();
                if (data.success) setCrashUI(data.round);
            } catch (e) {
                document.getElementById('crashError').textContent = 'Cannot connect to server.';
            }
        }

        document.getElementById('placeBetButton').onclick = async function() {
            const amt = parseFloat(document.getElementById('crashBetAmount').value);
            if (!amt || amt <= 0) return alert('Enter a valid bet.');
            try {
                const res = await fetch(`${API}/api/crash/bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount: amt })
                });
                const data = await res.json();
                if (data.success) {
                    userBetThisRound = true;
                    betAmount = amt;
                    fetchBalance();
                } else {
                    alert(data.message || 'Bet failed.');
                }
            } catch (e) {
                alert('Network error.');
            }
        };

        document.getElementById('cashoutButton').onclick = async function() {
            try {
                const res = await fetch(`${API}/api/crash/cashout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Cashed out for ${data.payout} BTC at ${data.multiplier.toFixed(2)}x!`);
                    userBetThisRound = false;
                    fetchBalance();
                } else {
                    alert(data.message || 'Cashout failed.');
                }
            } catch (e) {
                alert('Network error.');
            }
        };

        // ==== INITIALIZE ====
        (function() {
            if (authToken && localStorage.getItem('username')) {
                showGame();
                fetchBalance();
            } else {
                showModal('login');
            }
        })();
    </script>
</body>
</html>
